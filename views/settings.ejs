<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jukebar - JukePix Settings</title>
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/styles.css">
    <style>
        body.settings-page {
            overflow: auto;
        }

        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 40px 60px;
        }

        .settings-container h2 {
            font-size: 1.6em;
            font-weight: 700;
            color: #1db954;
            margin-bottom: 8px;
        }

        .settings-container .subtitle {
            color: #b3b3b3;
            font-size: 0.95em;
            margin-bottom: 28px;
        }

        /* Section Cards */
        .settings-section {
            background: #1a1a1a;
            border: 1px solid #282828;
            border-radius: 12px;
            padding: 24px 28px;
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 1.2em;
            color: #1db954;
            margin-bottom: 16px;
            border-bottom: 1px solid #282828;
            padding-bottom: 10px;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 24px;
        }

        .form-grid.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.85em;
            color: #b3b3b3;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            padding: 8px 10px;
            font-size: 0.95em;
            border: 1px solid #535353;
            border-radius: 6px;
            background: #121212;
            color: #fff;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #1db954;
        }

        /* Color picker row */
        .color-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-row input[type="color"] {
            width: 40px;
            height: 36px;
            border: 1px solid #535353;
            border-radius: 6px;
            background: #121212;
            cursor: pointer;
            padding: 2px;
        }

        .color-row input[type="text"] {
            flex: 1;
            font-family: monospace;
        }

        /* Range slider */
        .range-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .range-group input[type="range"] {
            flex: 1;
            accent-color: #1db954;
        }

        .range-value {
            color: #1db954;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* Action buttons */
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1db954;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1ed760;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn-secondary {
            background: #282828;
            color: #b3b3b3;
            border: 1px solid #535353;
        }

        .btn-secondary:hover {
            background: #333;
            color: #fff;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 0.85em;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        /* Overrides Table */
        .overrides-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .overrides-table th,
        .overrides-table td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #282828;
            font-size: 0.9em;
        }

        .overrides-table th {
            color: #b3b3b3;
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overrides-table td {
            color: #fff;
        }

        .color-swatch {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #535353;
            vertical-align: middle;
            margin-right: 6px;
        }

        .override-actions {
            display: flex;
            gap: 6px;
        }

        .empty-state {
            text-align: center;
            color: #535353;
            padding: 24px;
            font-size: 0.95em;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 22px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            background: #1db954;
            color: #fff;
        }

        .toast-error {
            background: #e74c3c;
            color: #fff;
        }

        /* Priority hint */
        .priority-hint {
            background: rgba(29, 185, 84, 0.08);
            border: 1px solid rgba(29, 185, 84, 0.25);
            border-radius: 8px;
            padding: 12px 16px;
            color: #b3b3b3;
            font-size: 0.88em;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .priority-hint strong {
            color: #1db954;
        }

        /* Preview */
        .preview-bar {
            height: 16px;
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
        }

        .preview-bar-fill {
            height: 100%;
            width: 60%;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .preview-text {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.95em;
            text-align: center;
            transition: all 0.3s;
        }

        /* Modal overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: #1a1a1a;
            border: 1px solid #282828;
            border-radius: 12px;
            padding: 28px;
            width: 500px;
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-box h3 {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="settings-page">
    <%- include('partials/header', { page: 'settings' }) %>

    <div class="settings-container">
        <h2>JukePix Settings</h2>
        <p class="subtitle">Configure display colors, progress bar, and sounds for the JukePix LED strip.</p>

        <!-- Global Defaults -->
        <div class="settings-section" id="defaults-section">
            <h3>Global Defaults</h3>
            <p class="priority-hint">
                These are the <strong>base settings</strong> used for every track unless overridden by an artist or song rule below.
            </p>

            <div class="form-grid">
                <div class="form-group">
                    <label>Text Color</label>
                    <div class="color-row">
                        <input type="color" id="def-text-color" value="#ffffff">
                        <input type="text" id="def-text-color-hex" value="#ffffff" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label>Background Color</label>
                    <div class="color-row">
                        <input type="color" id="def-bg-color" value="#000000">
                        <input type="text" id="def-bg-color-hex" value="#000000" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label>Progress Bar Color 1</label>
                    <div class="color-row">
                        <input type="color" id="def-fg1" value="#00ff00">
                        <input type="text" id="def-fg1-hex" value="#00ff00" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label>Progress Bar Color 2</label>
                    <div class="color-row">
                        <input type="color" id="def-fg2" value="#29ff29">
                        <input type="text" id="def-fg2-hex" value="#29ff29" maxlength="7">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Scroll Speed</label>
                    <div class="range-group">
                        <input type="range" id="def-scroll-speed" min="10" max="200" value="50">
                        <span class="range-value" id="def-scroll-speed-val">50</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Skip Sound</label>
                    <select id="def-skip-sound">
                        <option value="">None</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Shield Sound</label>
                    <select id="def-shield-sound">
                        <option value="">None</option>
                    </select>
                </div>
            </div>

            <!-- Preview -->
            <div style="margin-top: 20px;">
                <label style="font-size: 0.85em; color: #b3b3b3; font-weight: 500;">Preview</label>
                <div class="preview-text" id="def-preview-text">♪♫ Track Name - Artist ♪♫</div>
                <div class="preview-bar" id="def-preview-bar">
                    <div class="preview-bar-fill" id="def-preview-fill"></div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveDefaults()">Save Defaults</button>
            </div>
        </div>

        <!-- Overrides Section -->
        <div class="settings-section" id="overrides-section">
            <h3>Artist &amp; Song Overrides</h3>
            <p class="priority-hint">
                Override colors for specific artists or songs. Priority: <strong>Song</strong> &gt; <strong>Artist</strong> &gt; <strong>Global Defaults</strong>.
                <br>A song override will always take precedence over an artist override.
            </p>

            <button class="btn btn-primary btn-sm" onclick="openOverrideModal()">+ Add Override</button>

            <table class="overrides-table" id="overrides-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Match Value</th>
                        <th>Text</th>
                        <th>Bar 1</th>
                        <th>Bar 2</th>
                        <th>Speed</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="overrides-body">
                    <tr class="empty-state-row">
                        <td colspan="7" class="empty-state">No overrides configured yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Override Add/Edit Modal -->
    <div class="modal-overlay" id="override-modal">
        <div class="modal-box">
            <h3 id="modal-title">Add Override</h3>
            <input type="hidden" id="modal-edit-id" value="">

            <div class="form-grid">
                <div class="form-group">
                    <label>Type</label>
                    <select id="modal-type">
                        <option value="artist">Artist</option>
                        <option value="song">Song</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Match Value</label>
                    <input type="text" id="modal-value" placeholder="e.g. Pierce The Veil">
                </div>

                <div class="form-group" id="modal-artist-group" style="display:none;">
                    <label>Artist (optional, for song specificity)</label>
                    <input type="text" id="modal-artist" placeholder="e.g. Joji">
                </div>

                <div class="form-group">
                    <label>Text Color</label>
                    <div class="color-row">
                        <input type="color" id="modal-text-color" value="#ffffff">
                        <input type="text" id="modal-text-color-hex" value="#ffffff" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label>Progress Bar Color 1</label>
                    <div class="color-row">
                        <input type="color" id="modal-fg1" value="#00ff00">
                        <input type="text" id="modal-fg1-hex" value="#00ff00" maxlength="7">
                    </div>
                </div>

                <div class="form-group">
                    <label>Progress Bar Color 2</label>
                    <div class="color-row">
                        <input type="color" id="modal-fg2" value="#29ff29">
                        <input type="text" id="modal-fg2-hex" value="#29ff29" maxlength="7">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Scroll Speed</label>
                    <div class="range-group">
                        <input type="range" id="modal-scroll-speed" min="10" max="200" value="50">
                        <span class="range-value" id="modal-scroll-speed-val">50</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Skip Sound</label>
                    <select id="modal-skip-sound">
                        <option value="">None</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Shield Sound</label>
                    <select id="modal-shield-sound">
                        <option value="">None</option>
                    </select>
                </div>
            </div>

            <div class="btn-row" style="justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOverrideModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOverride()">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ── Helpers ──
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast toast-' + type + ' show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function api(url, opts = {}) {
            const res = await fetch(url, {
                headers: { 'Content-Type': 'application/json', ...opts.headers },
                ...opts
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || res.statusText);
            return data;
        }

        // ── Color picker sync ──
        function syncColor(pickerId, hexId) {
            const picker = document.getElementById(pickerId);
            const hex = document.getElementById(hexId);
            picker.addEventListener('input', () => { hex.value = picker.value; updatePreview(); });
            hex.addEventListener('input', () => {
                if (/^#[0-9a-fA-F]{6}$/.test(hex.value)) {
                    picker.value = hex.value;
                    updatePreview();
                }
            });
        }

        // Defaults color sync
        syncColor('def-text-color', 'def-text-color-hex');
        syncColor('def-bg-color', 'def-bg-color-hex');
        syncColor('def-fg1', 'def-fg1-hex');
        syncColor('def-fg2', 'def-fg2-hex');

        // Modal color sync
        syncColor('modal-text-color', 'modal-text-color-hex');
        syncColor('modal-fg1', 'modal-fg1-hex');
        syncColor('modal-fg2', 'modal-fg2-hex');

        // Range slider sync
        document.getElementById('def-scroll-speed').addEventListener('input', e => {
            document.getElementById('def-scroll-speed-val').textContent = e.target.value;
        });
        document.getElementById('modal-scroll-speed').addEventListener('input', e => {
            document.getElementById('modal-scroll-speed-val').textContent = e.target.value;
        });

        // Show artist field when type = song
        document.getElementById('modal-type').addEventListener('change', e => {
            document.getElementById('modal-artist-group').style.display = e.target.value === 'song' ? '' : 'none';
        });

        // ── Preview ──
        function updatePreview() {
            const txtC = document.getElementById('def-text-color').value;
            const bgC = document.getElementById('def-bg-color').value;
            const fg1 = document.getElementById('def-fg1').value;
            const fg2 = document.getElementById('def-fg2').value;

            const prevText = document.getElementById('def-preview-text');
            prevText.style.color = txtC;
            prevText.style.background = bgC;

            const prevFill = document.getElementById('def-preview-fill');
            prevFill.style.background = `linear-gradient(90deg, ${fg1}, ${fg2})`;

            const prevBar = document.getElementById('def-preview-bar');
            prevBar.style.background = '#282828';
        }

        // ── Sound dropdowns ──
        let soundFiles = [];

        async function loadSounds() {
            try {
                const data = await api('/api/settings/sounds');
                soundFiles = data.sounds || [];
            } catch (e) {
                console.error('Failed to load sounds:', e);
                soundFiles = [];
            }
            populateSoundSelect('def-skip-sound');
            populateSoundSelect('def-shield-sound');
            populateSoundSelect('modal-skip-sound');
            populateSoundSelect('modal-shield-sound');
        }

        function populateSoundSelect(selectId) {
            const sel = document.getElementById(selectId);
            const current = sel.value;
            sel.innerHTML = '<option value="">None</option>';
            soundFiles.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.textContent = f;
                sel.appendChild(opt);
            });
            sel.value = current || '';
        }

        // ── Load Defaults ──
        async function loadDefaults() {
            try {
                const data = await api('/api/settings/defaults');
                const d = data.defaults || {};

                setValue('def-text-color', d.text_color || '#ffffff');
                setValue('def-text-color-hex', d.text_color || '#ffffff');
                setValue('def-bg-color', d.bg_color || '#000000');
                setValue('def-bg-color-hex', d.bg_color || '#000000');
                setValue('def-fg1', d.progress_fg1 || '#00ff00');
                setValue('def-fg1-hex', d.progress_fg1 || '#00ff00');
                setValue('def-fg2', d.progress_fg2 || '#29ff29');
                setValue('def-fg2-hex', d.progress_fg2 || '#29ff29');

                document.getElementById('def-scroll-speed').value = d.scroll_speed || 50;
                document.getElementById('def-scroll-speed-val').textContent = d.scroll_speed || 50;

                document.getElementById('def-skip-sound').value = d.skip_sound || '';
                document.getElementById('def-shield-sound').value = d.shield_sound || '';

                updatePreview();
            } catch (e) {
                showToast('Failed to load defaults: ' + e.message, 'error');
            }
        }

        function setValue(id, val) {
            document.getElementById(id).value = val;
        }

        async function saveDefaults() {
            try {
                await api('/api/settings/defaults', {
                    method: 'PUT',
                    body: JSON.stringify({
                        text_color: document.getElementById('def-text-color').value,
                        bg_color: document.getElementById('def-bg-color').value,
                        progress_fg1: document.getElementById('def-fg1').value,
                        progress_fg2: document.getElementById('def-fg2').value,
                        scroll_speed: parseInt(document.getElementById('def-scroll-speed').value),
                        skip_sound: document.getElementById('def-skip-sound').value || null,
                        shield_sound: document.getElementById('def-shield-sound').value || null
                    })
                });
                showToast('Defaults saved!');
            } catch (e) {
                showToast('Save failed: ' + e.message, 'error');
            }
        }

        // ── Overrides ──
        let overrides = [];

        async function loadOverrides() {
            try {
                const data = await api('/api/settings/overrides');
                overrides = data.overrides || [];
                renderOverrides();
            } catch (e) {
                showToast('Failed to load overrides: ' + e.message, 'error');
            }
        }

        function renderOverrides() {
            const tbody = document.getElementById('overrides-body');
            if (overrides.length === 0) {
                tbody.innerHTML = '<tr class="empty-state-row"><td colspan="7" class="empty-state">No overrides configured yet.</td></tr>';
                return;
            }

            tbody.innerHTML = overrides.map(o => `
                <tr>
                    <td><span style="text-transform:capitalize;">${o.match_type}</span></td>
                    <td>${escHtml(o.match_value)}${o.match_artist ? ' <span style="color:#535353">by</span> ' + escHtml(o.match_artist) : ''}</td>
                    <td>${o.text_color ? '<span class="color-swatch" style="background:' + o.text_color + '"></span>' + o.text_color : '—'}</td>
                    <td>${o.progress_fg1 ? '<span class="color-swatch" style="background:' + o.progress_fg1 + '"></span>' + o.progress_fg1 : '—'}</td>
                    <td>${o.progress_fg2 ? '<span class="color-swatch" style="background:' + o.progress_fg2 + '"></span>' + o.progress_fg2 : '—'}</td>
                    <td>${o.scroll_speed || '—'}</td>
                    <td class="override-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editOverride(${o.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOverride(${o.id})">Del</button>
                    </td>
                </tr>
            `).join('');
        }

        function escHtml(str) {
            const d = document.createElement('div');
            d.textContent = str || '';
            return d.innerHTML;
        }

        // ── Modal ──
        function openOverrideModal(data = null) {
            const modal = document.getElementById('override-modal');
            document.getElementById('modal-title').textContent = data ? 'Edit Override' : 'Add Override';
            document.getElementById('modal-edit-id').value = data ? data.id : '';

            document.getElementById('modal-type').value = data?.match_type || 'artist';
            document.getElementById('modal-value').value = data?.match_value || '';
            document.getElementById('modal-artist').value = data?.match_artist || '';
            document.getElementById('modal-artist-group').style.display = (data?.match_type === 'song') ? '' : 'none';

            setValue('modal-text-color', data?.text_color || '#ffffff');
            setValue('modal-text-color-hex', data?.text_color || '#ffffff');
            setValue('modal-fg1', data?.progress_fg1 || '#00ff00');
            setValue('modal-fg1-hex', data?.progress_fg1 || '#00ff00');
            setValue('modal-fg2', data?.progress_fg2 || '#29ff29');
            setValue('modal-fg2-hex', data?.progress_fg2 || '#29ff29');

            document.getElementById('modal-scroll-speed').value = data?.scroll_speed || 50;
            document.getElementById('modal-scroll-speed-val').textContent = data?.scroll_speed || 50;

            document.getElementById('modal-skip-sound').value = data?.skip_sound || '';
            document.getElementById('modal-shield-sound').value = data?.shield_sound || '';

            modal.classList.add('active');
        }

        function closeOverrideModal() {
            document.getElementById('override-modal').classList.remove('active');
        }

        function editOverride(id) {
            const o = overrides.find(x => x.id === id);
            if (o) openOverrideModal(o);
        }

        async function saveOverride() {
            const editId = document.getElementById('modal-edit-id').value;
            const body = {
                match_type: document.getElementById('modal-type').value,
                match_value: document.getElementById('modal-value').value.trim(),
                match_artist: document.getElementById('modal-type').value === 'song'
                    ? (document.getElementById('modal-artist').value.trim() || null)
                    : null,
                text_color: document.getElementById('modal-text-color').value,
                progress_fg1: document.getElementById('modal-fg1').value,
                progress_fg2: document.getElementById('modal-fg2').value,
                scroll_speed: parseInt(document.getElementById('modal-scroll-speed').value),
                skip_sound: document.getElementById('modal-skip-sound').value || null,
                shield_sound: document.getElementById('modal-shield-sound').value || null
            };

            if (!body.match_value) {
                showToast('Match value is required', 'error');
                return;
            }

            try {
                if (editId) {
                    await api('/api/settings/overrides', {
                        method: 'PUT',
                        body: JSON.stringify({ id: parseInt(editId), ...body })
                    });
                    showToast('Override updated!');
                } else {
                    await api('/api/settings/overrides', {
                        method: 'POST',
                        body: JSON.stringify(body)
                    });
                    showToast('Override added!');
                }
                closeOverrideModal();
                await loadOverrides();
            } catch (e) {
                showToast('Save failed: ' + e.message, 'error');
            }
        }

        async function deleteOverride(id) {
            if (!confirm('Delete this override?')) return;
            try {
                await api('/api/settings/overrides', {
                    method: 'DELETE',
                    body: JSON.stringify({ id })
                });
                showToast('Override deleted.');
                await loadOverrides();
            } catch (e) {
                showToast('Delete failed: ' + e.message, 'error');
            }
        }

        // Close modal on outside click
        document.getElementById('override-modal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeOverrideModal();
        });

        // ── Init ──
        (async () => {
            await loadSounds();
            await loadDefaults();
            await loadOverrides();
        })();
    </script>
</body>

</html>
