<div class="card">
    <h3>Transfer</h3>
    <div class="row price-display">
        <div class="price-content">
            <span class="price-label">Purchase Cost:</span>
            <span class="price-amount" id="price">50 Digipogs</span>
        </div>
        <span class="discount-display" id="discount"></span>
    </div>
    <div class="row">
        <label class="small">PIN</label>
        <div><input id="pin" type="password" pattern="\d*" inputmode="numeric" maxlength="6"
                placeholder="Input your PIN" oninput="this.value = this.value.replace(/[^0-9]/g,'');" /></div>
    </div>
    <div class="row">
        <label class="medium label-inline" for="savePIN">
            Save PIN for next purchase
            <input id="savePIN" type="checkbox" />
        </label>
        <label class="small checkbox-note">Note: Changing your PIN will require re-entry for future
            transactions.</label>
    </div>
    <div class="row" id="anonModeRow" style="display: none;">
        <label class="medium label-inline" for="anonMode">
            Anonymous Mode
            <input id="anonMode" type="checkbox" />
        </label>
        <label class="small checkbox-note">Hides your name from the public queue display. Teachers can still view
            who added the song, and it will appear in your transaction history.</label>
    </div>
    <div class="actions"><button class="primary" id="transferBtn">Send Transfer</button></div>
</div>
<script>
    (function () {
        'use strict';

        const pinInput = document.getElementById('pin');
        const savePIN = document.getElementById('savePIN');
        const transferBtn = document.getElementById('transferBtn');

        // Load saved PIN on page load
        async function loadSavedPin() {
            try {
                const savedPin = await getSavedPin();
                if (savedPin) {
                    pinInput.value = savedPin;
                    savePIN.checked = true; // Check the save PIN checkbox if we loaded a PIN
                }
            } catch (error) {
                console.error('Failed to load saved PIN:', error);
            }
        }

        async function getSavedPin() {
            try {
                const res = await fetch('/getPin', { method: 'POST' });
                const data = await res.json();
                if (!data.ok) {
                    console.error('Failed to retrieve saved PIN', data.error);
                    return '';
                }
                return data.userPin || '';
            } catch (error) {
                console.error('Error fetching saved PIN:', error);
                return '';
            }
        }

        // Load saved PIN when the page loads
        loadSavedPin();
        async function post(path, body) {
            const res = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const text = await res.text();
            try { return JSON.parse(text); } catch { return { raw: text }; }
        }
        async function doTransfer() {
            const pin = pinInput.value;
            const state = window.getPlayerState?.() || {};
            const pendingAction = state.pendingAction;

            // Save PIN if checkbox is checked
            if (savePIN.checked) {
                try {
                    await post('/savePin', { pin });
                } catch (error) {
                    console.error('Failed to save PIN:', error);
                }
            }

            let reason = 'Jukebar Payment';
            let amount;

            if (pendingAction === 'play') {
                reason += ' - Play Track';
                amount = 50;
            } else if (pendingAction === 'skip') {
                reason += ' - Skip Track';
                amount = 75;
            } else if (pendingAction === 'Skip Shield') {
                reason += ' - Purchase Skip Shield for ' + state.pendingTrackUri;
                amount = 25;
            } else {
                console.error('Unknown pending action:', pendingAction);
                alert('Unknown action. Please try again. Your digipogs have not been charged.');
                return;
            }

            if (!pin) {
                alert('Please enter your PIN.');
                return;
            }

            try {
                const result = await post('/transfer', { pin, reason, pendingAction });

                const isSuccess = result.ok === true || result.success === true || result.status === 'success' ||
                    (result.error === undefined && result.token !== undefined);

                if (isSuccess) {
                    // Notify player.ejs via custom event
                    window.setPlayerState?.({ hasPaid: true });
                    window.dispatchEvent(new CustomEvent('paymentSuccess'));
                    window.dispatchEvent(new CustomEvent('hidePaymentModal'));
                    return;
                } else {
                    let errorMessage = result.error || result.message || 'Unknown error';
                    alert('Transfer failed: ' + errorMessage);
                    console.error('Transfer failed:', result);
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('Transfer failed: Network error');
            }
        }

        async function getPrice() {
            const state = window.getPlayerState?.() || {};
            const pendingAction = state.pendingAction;

            try {
                const res = await fetch('/getAmount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pendingAction })
                });
                const data = await res.json();

                if (data.ok) {
                    document.getElementById('price').innerText = `${data.amount} Digipogs`;

                    // Show/hide anonymous mode based on action type
                    const anonModeRow = document.getElementById('anonModeRow');
                    if (pendingAction === 'play') {
                        anonModeRow.style.display = 'flex';
                    } else {
                        anonModeRow.style.display = 'none';
                    }

                    if (pendingAction === 'play' && data.discountApplied) {
                        document.getElementsByClassName('row price-display')[0].style.border = '1px solid rgba(255, 215, 0, 0.5)';
                        document.getElementsByClassName('row price-display')[0].style.background = 'rgba(255, 215, 0, 0.15)';
                        document.getElementById('discount').innerText = 'Leaderboard discount applied!';
                    } else {
                        document.getElementById('discount').innerText = '';
                    }
                } else {
                    console.error('Error loading price:', data.error);
                    document.getElementById('price').innerText = 'Error loading price';
                }
            } catch (error) {
                console.error('Error fetching price:', error);
                document.getElementById('price').innerText = 'Error loading price';
            }
        }

        // Wire up event listeners
        transferBtn?.addEventListener('click', doTransfer);

        // Listen for price update requests from player.ejs
        window.addEventListener('updatePrice', (e) => {
            getPrice();
        });

        // Load saved PIN when included
        loadSavedPin();
    })();
</script>

</html>