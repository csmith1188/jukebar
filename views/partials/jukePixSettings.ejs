<!-- JukePix Settings Drawer -->
<div class="jp-drawer-overlay" id="jpDrawerOverlay" onclick="closeJPSettings()"></div>

<div class="jp-drawer" id="jpDrawer">
    <div class="jp-drawer-header">
        <h2>JukePix Settings</h2>
        <button class="jp-close-btn" onclick="closeJPSettings()" title="Close">&#x2715;</button>
    </div>
    <div class="jp-drawer-body">

        <!-- Global Defaults -->
        <div class="jp-section">
            <h3>Global Defaults</h3>
            <p class="jp-hint">Base settings used for every track unless overridden below.</p>

            <div class="jp-form-grid">
                <div class="jp-form-group">
                    <label>Text Color</label>
                    <div class="jp-color-row">
                        <input type="color" id="def-text-color" value="#ffffff">
                        <input type="text" id="def-text-color-hex" value="#ffffff" maxlength="7">
                    </div>
                </div>
                <div class="jp-form-group">
                    <label>Background Color</label>
                    <div class="jp-color-row">
                        <input type="color" id="def-bg-color" value="#000000">
                        <input type="text" id="def-bg-color-hex" value="#000000" maxlength="7">
                    </div>
                </div>
                <div class="jp-form-group">
                    <label>Progress Bar Color 1</label>
                    <div class="jp-color-row">
                        <input type="color" id="def-fg1" value="#00ff00">
                        <input type="text" id="def-fg1-hex" value="#00ff00" maxlength="7">
                    </div>
                </div>
                <div class="jp-form-group">
                    <label>Progress Bar Color 2</label>
                    <div class="jp-color-row">
                        <input type="color" id="def-fg2" value="#29ff29">
                        <input type="text" id="def-fg2-hex" value="#29ff29" maxlength="7">
                    </div>
                </div>
                <div class="jp-form-group jp-full-width">
                    <label>Scroll Speed</label>
                    <div class="jp-range-row">
                        <input type="range" id="def-scroll-speed" min="10" max="200" value="50">
                        <span class="jp-range-val" id="def-scroll-speed-val">50</span>
                    </div>
                </div>
                <div class="jp-form-group">
                    <label>Skip Sound</label>
                    <select id="def-skip-sound">
                        <option value="">None</option>
                    </select>
                </div>
                <div class="jp-form-group">
                    <label>Shield Sound</label>
                    <select id="def-shield-sound">
                        <option value="">None</option>
                    </select>
                </div>
            </div>

            <div class="jp-preview-wrap">
                <label>Preview</label>
                <div class="jp-preview-text" id="def-preview-text">♪♫ Track Name - Artist ♪♫</div>
                <div class="jp-preview-bar">
                    <div class="jp-preview-fill" id="def-preview-fill"></div>
                </div>
            </div>

            <div class="jp-btn-row">
                <button class="jp-btn jp-btn-primary" onclick="jpSaveDefaults()">Save Defaults</button>
                <button class="jp-btn jp-btn-secondary" onclick="jpResetDefaults()">Reset to Default</button>
            </div>
        </div>

        <!-- Overrides -->
        <div class="jp-section">
            <h3>Artist &amp; Song Overrides</h3>
            <p class="jp-hint">
                Priority: <strong>Song</strong> &gt; <strong>Artist</strong> &gt; <strong>Defaults</strong>
            </p>
            <button class="jp-btn jp-btn-primary jp-btn-sm" onclick="openJPModal()">+ Add Override</button>

            <div class="jp-table-wrap">
                <table class="jp-table">
                    <colgroup>
                        <col class="col-type">
                        <col class="col-match">
                        <col class="col-swatch">
                        <col class="col-swatch">
                        <col class="col-swatch">
                        <col class="col-spd">
                        <col class="col-act">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Match</th>
                            <th title="Text color">Txt</th>
                            <th title="Bar color 1">B1</th>
                            <th title="Bar color 2">B2</th>
                            <th>Spd</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="jp-overrides-body">
                        <tr>
                            <td colspan="7" class="jp-empty">No overrides yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div><!-- /jp-drawer-body -->
</div>

<!-- Override Add/Edit Modal -->
<div class="jp-modal-overlay" id="jpModalOverlay">
    <div class="jp-modal">
        <h3 id="jp-modal-title">Add Override</h3>
        <input type="hidden" id="jp-modal-id">

        <div class="jp-form-grid">
            <div class="jp-form-group">
                <label>Type</label>
                <select id="jp-modal-type">
                    <option value="artist">Artist</option>
                    <option value="song">Song</option>
                </select>
            </div>
            <div class="jp-form-group">
                <label>Match Value</label>
                <input type="text" id="jp-modal-value" placeholder="e.g. Pierce The Veil">
            </div>
            <div class="jp-form-group jp-full-width" id="jp-modal-artist-group" style="display:none;">
                <label>Artist <span style="color:#535353">(optional)</span></label>
                <input type="text" id="jp-modal-artist" placeholder="e.g. Joji">
            </div>
            <div class="jp-form-group">
                <label>Text Color</label>
                <div class="jp-color-row">
                    <input type="color" id="jp-modal-text-color" value="#ffffff">
                    <input type="text" id="jp-modal-text-color-hex" value="#ffffff" maxlength="7">
                </div>
            </div>
            <div class="jp-form-group">
                <label>Progress Bar Color 1</label>
                <div class="jp-color-row">
                    <input type="color" id="jp-modal-fg1" value="#00ff00">
                    <input type="text" id="jp-modal-fg1-hex" value="#00ff00" maxlength="7">
                </div>
            </div>
            <div class="jp-form-group">
                <label>Progress Bar Color 2</label>
                <div class="jp-color-row">
                    <input type="color" id="jp-modal-fg2" value="#29ff29">
                    <input type="text" id="jp-modal-fg2-hex" value="#29ff29" maxlength="7">
                </div>
            </div>
            <div class="jp-form-group jp-full-width">
                <label>Scroll Speed</label>
                <div class="jp-range-row">
                    <input type="range" id="jp-modal-scroll-speed" min="10" max="200" value="50">
                    <span class="jp-range-val" id="jp-modal-scroll-speed-val">50</span>
                </div>
            </div>
            <div class="jp-form-group">
                <label>Skip Sound</label>
                <select id="jp-modal-skip-sound">
                    <option value="">None</option>
                </select>
            </div>
            <div class="jp-form-group">
                <label>Shield Sound</label>
                <select id="jp-modal-shield-sound">
                    <option value="">None</option>
                </select>
            </div>
        </div>

        <div class="jp-btn-row" style="justify-content:flex-end;">
            <button class="jp-btn jp-btn-secondary" onclick="closeJPModal()">Cancel</button>
            <button class="jp-btn jp-btn-primary" onclick="jpSaveOverride()">Save</button>
        </div>
    </div>
</div>
<script>
    /* ── Helpers ── */
    async function jpApi(url, opts = {}) {
        const res = await fetch(url, {
            headers: { 'Content-Type': 'application/json', ...opts.headers },
            ...opts
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || res.statusText);
        return data;
    }

    /* ── Drawer open/close ── */
    function openJPSettings() {
        document.getElementById('jpDrawer').classList.add('open');
        document.getElementById('jpDrawerOverlay').classList.add('open');
        if (!jpSettingsLoaded) {
            jpSettingsLoaded = true;
            jpLoadAll();
        }
    }
    function closeJPSettings() {
        document.getElementById('jpDrawer').classList.remove('open');
        document.getElementById('jpDrawerOverlay').classList.remove('open');
    }

    let jpSettingsLoaded = false;
    let jpSoundFiles = [];
    let jpOverrides = [];

    async function jpLoadAll() {
        await jpLoadSounds();
        await jpLoadDefaults();
        await jpLoadOverrides();
    }

    /* ── Color sync ── */
    function jpSyncColor(pickerId, hexId, onUpdate) {
        const picker = document.getElementById(pickerId);
        const hex = document.getElementById(hexId);
        picker.addEventListener('input', () => { hex.value = picker.value; if (onUpdate) onUpdate(); });
        hex.addEventListener('input', () => {
            if (/^#[0-9a-fA-F]{6}$/.test(hex.value)) {
                picker.value = hex.value;
                if (onUpdate) onUpdate();
            }
        });
    }

    function jpUpdatePreview() {
        const txtC = document.getElementById('def-text-color').value;
        const bgC = document.getElementById('def-bg-color').value;
        const fg1 = document.getElementById('def-fg1').value;
        const fg2 = document.getElementById('def-fg2').value;
        const t = document.getElementById('def-preview-text');
        t.style.color = txtC;
        t.style.background = bgC;
        document.getElementById('def-preview-fill').style.background = `linear-gradient(90deg, ${fg1}, ${fg2})`;
    }

    // Defaults
    jpSyncColor('def-text-color', 'def-text-color-hex', jpUpdatePreview);
    jpSyncColor('def-bg-color', 'def-bg-color-hex', jpUpdatePreview);
    jpSyncColor('def-fg1', 'def-fg1-hex', jpUpdatePreview);
    jpSyncColor('def-fg2', 'def-fg2-hex', jpUpdatePreview);
    document.getElementById('def-scroll-speed').addEventListener('input', e => {
        document.getElementById('def-scroll-speed-val').textContent = e.target.value;
    });

    // Modal
    jpSyncColor('jp-modal-text-color', 'jp-modal-text-color-hex');
    jpSyncColor('jp-modal-fg1', 'jp-modal-fg1-hex');
    jpSyncColor('jp-modal-fg2', 'jp-modal-fg2-hex');
    document.getElementById('jp-modal-scroll-speed').addEventListener('input', e => {
        document.getElementById('jp-modal-scroll-speed-val').textContent = e.target.value;
    });
    document.getElementById('jp-modal-type').addEventListener('change', e => {
        document.getElementById('jp-modal-artist-group').style.display = e.target.value === 'song' ? '' : 'none';
    });

    /* ── Sounds ── */
    async function jpLoadSounds() {
        try {
            const data = await jpApi('/api/settings/sounds');
            jpSoundFiles = data.sounds || [];
        } catch (e) { jpSoundFiles = []; }
        ['def-skip-sound', 'def-shield-sound', 'jp-modal-skip-sound', 'jp-modal-shield-sound'].forEach(id => {
            const sel = document.getElementById(id);
            const cur = sel.value;
            sel.innerHTML = '<option value="">None</option>';
            jpSoundFiles.forEach(f => {
                const o = document.createElement('option');
                o.value = f; o.textContent = f;
                sel.appendChild(o);
            });
            sel.value = cur || '';
        });
    }

    /* ── Defaults ── */
    async function jpLoadDefaults() {
        try {
            const data = await jpApi('/api/settings/defaults');
            const d = data.defaults || {};
            const set = (id, v) => { document.getElementById(id).value = v; };
            set('def-text-color', d.text_color || '#ffffff');
            set('def-text-color-hex', d.text_color || '#ffffff');
            set('def-bg-color', d.bg_color || '#000000');
            set('def-bg-color-hex', d.bg_color || '#000000');
            set('def-fg1', d.progress_fg1 || '#00ff00');
            set('def-fg1-hex', d.progress_fg1 || '#00ff00');
            set('def-fg2', d.progress_fg2 || '#29ff29');
            set('def-fg2-hex', d.progress_fg2 || '#29ff29');
            document.getElementById('def-scroll-speed').value = d.scroll_speed || 50;
            document.getElementById('def-scroll-speed-val').textContent = d.scroll_speed || 50;
            document.getElementById('def-skip-sound').value = d.skip_sound || '';
            document.getElementById('def-shield-sound').value = d.shield_sound || '';
            jpUpdatePreview();
        } catch (e) { showNotification('Failed to load JukePix defaults', 'error'); }
    }

    async function jpSaveDefaults() {
        try {
            await jpApi('/api/settings/defaults', {
                method: 'PUT',
                body: JSON.stringify({
                    text_color: document.getElementById('def-text-color').value,
                    bg_color: document.getElementById('def-bg-color').value,
                    progress_fg1: document.getElementById('def-fg1').value,
                    progress_fg2: document.getElementById('def-fg2').value,
                    scroll_speed: parseInt(document.getElementById('def-scroll-speed').value),
                    skip_sound: document.getElementById('def-skip-sound').value || null,
                    shield_sound: document.getElementById('def-shield-sound').value || null
                })
            });
            showNotification('JukePix defaults saved!', 'success');
        } catch (e) { showNotification('Save failed: ' + e.message, 'error'); }
    }

    async function jpResetDefaults() {
        if (!confirm('Reset all JukePix defaults back to the original values?')) return;
        try {
            await jpApi('/api/settings/defaults/reset', { method: 'POST' });
            await jpLoadDefaults();
            showNotification('JukePix defaults reset!', 'success');
        } catch (e) { showNotification('Reset failed: ' + e.message, 'error'); }
    }

    /* ── Overrides ── */
    async function jpLoadOverrides() {
        try {
            const data = await jpApi('/api/settings/overrides');
            jpOverrides = data.overrides || [];
            jpRenderOverrides();
        } catch (e) { showNotification('Failed to load overrides', 'error'); }
    }

    function jpRenderOverrides() {
        const tbody = document.getElementById('jp-overrides-body');
        if (!jpOverrides.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="jp-empty">No overrides yet.</td></tr>';
            return;
        }
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
        function trunc(s, n) { s = s || ''; return s.length > n ? esc(s.slice(0, n)) + '…' : esc(s); }
        tbody.innerHTML = jpOverrides.map(o => `
        <tr>
            <td style="text-transform:capitalize">${o.match_type}</td>
            <td title="${esc(o.match_value)}${o.match_artist ? ' / ' + esc(o.match_artist) : ''}">${trunc(o.match_value, 24)}${o.match_artist ? '<span style="color:#535353"> / ' + trunc(o.match_artist, 14) + '</span>' : ''}</td>
            <td title="${o.text_color || ''}"><span class="jp-swatch" style="background:${o.text_color || '#444'}"></span></td>
            <td title="${o.progress_fg1 || ''}"><span class="jp-swatch" style="background:${o.progress_fg1 || '#444'}"></span></td>
            <td title="${o.progress_fg2 || ''}"><span class="jp-swatch" style="background:${o.progress_fg2 || '#444'}"></span></td>
            <td>${o.scroll_speed || '—'}</td>
            <td class="jp-override-actions">
                <button class="jp-icon-btn" onclick="jpEditOverride(${o.id})" title="Edit"><img src="/img/edit.png" alt="Edit"></button>
                <button class="jp-icon-btn jp-icon-btn-danger" onclick="jpDeleteOverride(${o.id})" title="Delete"><img src="/img/trash.png" alt="Delete"></button>
            </td>
        </tr>
        `).join('');
    }

    /* ── Modal ── */
    function openJPModal(data = null) {
        document.getElementById('jp-modal-title').textContent = data ? 'Edit Override' : 'Add Override';
        document.getElementById('jp-modal-id').value = data ? data.id : '';
        const set = (id, v) => { document.getElementById(id).value = v; };
        set('jp-modal-type', data?.match_type || 'artist');
        set('jp-modal-value', data?.match_value || '');
        set('jp-modal-artist', data?.match_artist || '');
        document.getElementById('jp-modal-artist-group').style.display = (data?.match_type === 'song') ? '' : 'none';
        set('jp-modal-text-color', data?.text_color || '#ffffff');
        set('jp-modal-text-color-hex', data?.text_color || '#ffffff');
        set('jp-modal-fg1', data?.progress_fg1 || '#00ff00');
        set('jp-modal-fg1-hex', data?.progress_fg1 || '#00ff00');
        set('jp-modal-fg2', data?.progress_fg2 || '#29ff29');
        set('jp-modal-fg2-hex', data?.progress_fg2 || '#29ff29');
        document.getElementById('jp-modal-scroll-speed').value = data?.scroll_speed || 50;
        document.getElementById('jp-modal-scroll-speed-val').textContent = data?.scroll_speed || 50;
        set('jp-modal-skip-sound', data?.skip_sound || '');
        set('jp-modal-shield-sound', data?.shield_sound || '');
        document.getElementById('jpModalOverlay').classList.add('active');
    }
    function closeJPModal() {
        document.getElementById('jpModalOverlay').classList.remove('active');
    }
    function jpEditOverride(id) {
        const o = jpOverrides.find(x => x.id === id);
        if (o) openJPModal(o);
    }
    async function jpSaveOverride() {
        const editId = document.getElementById('jp-modal-id').value;
        const type = document.getElementById('jp-modal-type').value;
        const body = {
            match_type: type,
            match_value: document.getElementById('jp-modal-value').value.trim(),
            match_artist: type === 'song' ? (document.getElementById('jp-modal-artist').value.trim() || null) : null,
            text_color: document.getElementById('jp-modal-text-color').value,
            progress_fg1: document.getElementById('jp-modal-fg1').value,
            progress_fg2: document.getElementById('jp-modal-fg2').value,
            scroll_speed: parseInt(document.getElementById('jp-modal-scroll-speed').value),
            skip_sound: document.getElementById('jp-modal-skip-sound').value || null,
            shield_sound: document.getElementById('jp-modal-shield-sound').value || null
        };
        if (!body.match_value) { showNotification('Match value is required', 'error'); return; }
        try {
            if (editId) {
                await jpApi(`/api/settings/overrides/${editId}`, { method: 'PUT', body: JSON.stringify(body) });
                showNotification('Override updated!', 'success');
            } else {
                await jpApi('/api/settings/overrides', { method: 'POST', body: JSON.stringify(body) });
                showNotification('Override added!', 'success');
            }
            closeJPModal();
            await jpLoadOverrides();
        } catch (e) { showNotification('Save failed: ' + e.message, 'error'); }
    }
    async function jpDeleteOverride(id) {
        if (!confirm('Delete this override?')) return;
        try {
            await jpApi(`/api/settings/overrides/${id}`, { method: 'DELETE' });
            showNotification('Override deleted.', 'success');
            await jpLoadOverrides();
        } catch (e) { showNotification('Delete failed: ' + e.message, 'error'); }
    }
    document.getElementById('jpModalOverlay').addEventListener('click', e => {
        if (e.target === e.currentTarget) closeJPModal();
    });
</script>