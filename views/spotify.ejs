<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player</title>
    <link rel="stylesheet" href="../styles/sp.css">
</head>

<body id="colorContent">
    <%- include("partials/header.ejs") %>

    <div id="content" class="contentBox">
        <h1>Spotify Player</h1>
        <div id="search">
            <p>Search for a song to play:</p>
            <input type="text" id="searchBar" placeholder="Search for a song">
            <button type="submit" class="searchButton" onclick="search()">Search</button>

            <div id="current">
                <p>Current Song:</p>
            </div>

            <div id="searchResults"></div>
        </div>
        
        <%- include("partials/footer.ejs") %>

        <script>
            const searchResults = document.getElementById("searchResults");

            function search() {
                const query = document.getElementById('searchBar').value;
                if (!query) return alert("Please enter a song name.");

                fetch(`/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error === 'explicit') {
                            alert('Only explicit versions of this song were found. Try searching for a clean version.');
                            searchResults.innerHTML = '';
                        } else if (data.error) {
                            searchResults.innerHTML = `<p>Error: ${data.error}</p>`;
                        } else {
                            searchResults.innerHTML = `
                                <h3>${data.name}</h3>
                                <p>Artist: ${data.artist}</p>
                                <button onclick="playSong('${data.uri}')" class='playback'>Play</button>
                            `;
                        }
                    })
                    .catch(err => {
                        console.error('Fetch Error:', err);
                        searchResults.innerHTML = "An error occurred while searching.";
                    });
            }

            function playSong(uri) {
                console.log("Attempting to play song with URI:", uri);

                fetch('/play', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ uri: uri })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error === 'explicit') {
                            alert('This song contains explicit content and cannot be played.');
                        } else if (data.success) {
                            alert("Playing song: " + data.trackInfo.name);
                        } else {
                            alert("Error: " + (data.error || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        console.error('Fetch Error:', err);
                        alert("Failed to play song: " + (err.error || err.message || "Unknown error"));
                    });
            }
        </script>
</body>

</html>
